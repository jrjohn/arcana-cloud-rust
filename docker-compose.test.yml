services:
  test:
    # Standard cargo test (existing)
    build:
      context: .
      dockerfile: Dockerfile.ci
      target: builder
    working_dir: /app
    command: sh -c "cargo test --workspace --no-fail-fast 2>&1 || true"

  coverage:
    # Tarpaulin coverage - generates lcov.info for SonarQube
    image: xd009642/tarpaulin:latest
    working_dir: /app
    volumes:
      - .:/app
      - ./coverage:/output
    security_opt:
      - seccomp:unconfined
    command: >
      cargo tarpaulin --workspace --no-fail-fast
        --out Lcov --output-dir /output
        --timeout 120
        2>&1 || true
